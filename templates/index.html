<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>CodePen - Web Audio Visualizer 01: Spectrogram</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
  <style type="text/css">html, body {
    height: 100%;
  }
  
  canvas {
    display: block;
    height: 10%;
    width: 10%;
  }
  /*
  h1 {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0;
  }*/
  </style>

  <script>
console.clear();

// UPDATE: there is a problem in chrome with starting audio context
//  before a user gesture. This fixes it.
var started = null;
window.addEventListener('click', () => {
  if (started) return;
  started = true;
  
  initialize();
});


function initialize() {
  document.body.querySelector('h1').remove();

  //Canvas FFT in time domain initialization
  const CVS = document.body.querySelector('canvas');
  const CTX = CVS.getContext('2d');



  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const W = CVS.width = window.innerWidth;
  const H = CVS.height = window.innerHeight;

  const bufferFill = 2756
  const myArrayBuffer = audioCtx.createBuffer(1, bufferFill , 22050);
  
  //Create Analyser
  const analyser = audioCtx.createAnalyser();
  let nowBuffering = myArrayBuffer.getChannelData(0)
        
  


  $(document).ready(function(){
    //connect to the socket server.
    var socket = io.connect('http://' + document.domain + ':' + location.port + '/test');
    var numbers_received = [];
    //receive details from server
    socket.on('newnumber', function(chunk) {
        for (var z = 0; z < 10; z++) {

          var data = JSON.parse(chunk.number);
          data =  data.slice(z*bufferFill, (z+1)*bufferFill)
          console.time('Execution Time');
          for (var i = 0; i < data.length; i++) {
            // nowBuffering[i] = Math.random() * 2 - 1;
            nowBuffering[i] = data[i];
          }
          console.timeEnd('Execution Time');
          console.log("buffer length: " + nowBuffering.length + "  " + data.length);

          
          // Get an AudioBufferSourceNode.
          // This is the AudioNode to use when we want to play an AudioBuffer
          const source = audioCtx.createBufferSource();
          // set the buffer in the AudioBufferSourceNode
          source.buffer = myArrayBuffer;
          //Analyser
          analyser.fftSize = 256;
          const bufferLength = analyser.frequencyBinCount;
          var array = new Uint8Array(bufferLength);
          source.connect(analyser);
          analyser.getByteFrequencyData(array);
          console.log("FFT_array: " + array);

          // start the source playing
          source.start(0);
        }
        //maintain a list of ten numbers
        if (numbers_received.length >= 10){
            numbers_received.shift()
        }
        numbers_received.push(chunk.number);
        numbers_string = '';
        for (var i = 0; i < numbers_received.length; i++){
            numbers_string = numbers_string + '<p>' + numbers_received[i].toString() + '</p>';
        }
        $('#log').html(numbers_string);
    });
});

}

/*function initialize() {
  document.body.querySelector('h1').remove();
  const CVS = document.body.querySelector('canvas');
  const CTX = CVS.getContext('2d');
  const W = CVS.width = window.innerWidth;
  const H = CVS.height = window.innerHeight;

  // const ACTX = new AudioContext();
  // const ANALYSER = ACTX.createAnalyser();

  // ANALYSER.fftSize = 4096;

  // navigator.mediaDevices.
  // getUserMedia({ audio: true }).
  // then(process);

  // function requestData() {
  //   //Ajax call to get the Data from Flask
  //   var requests =  $.get('/img_to_flask');
  //   var tm = requests.done(function (result) {
  //     console.log("[TEMPERATURE]", result);
  //   });
  
  
  // }
/*
  function process() {
    const W = 32*20 // 20 timesteps
    const H = 96*32
    const LEN = 32
    const h = H / 32;
    const x = W - 1;
    CTX.fillStyle = 'hsl(280, 100%, 10%)';
    CTX.fillRect(0, 0, W, H);
    console.log("starting loop");


    function loop(DATA) {
      //window.requestAnimationFrame(loop);

      let imgData = CTX.getImageData(1, 0, W - 1, H);
      //
      CTX.fillRect(0, 0, W, H);
      CTX.putImageData(imgData, 0, 0);
      CTX.drawImage(img, 10, 10);   
         
      // for (let i = 0; i < LEN; i++) {
      //   let rat = DATA[i] /// 255;
      //   let hue = Math.round(rat * 120 + 280 % 360);
      //   let sat = '100%';
      //   let lit = 10 + 70 * rat + '%';
      //   CTX.beginPath();
      //   CTX.strokeStyle = `hsl(${hue}, ${sat}, ${lit})`;
      //   CTX.moveTo(x, H - i * h);
      //   CTX.lineTo(x, H - (i * h + h));
      //   CTX.stroke();
      // }
    }
  

*/  


</script>
</head>
<body>
<!-- partial:index.partial.html -->
<h1>Click to start</h1>
<canvas></canvas>

<!-- partial -->
<h2>
<div class="container">
  <div class="jumbotron">
    <h2>Asynchronous Flask Communication</h2>
    <p>Random numbers generated by the Flask server will appear below, asynchronously.</p>
    
  </div>
</div>
    
</div>

<div class="container" id="content">
    <div class="row">

        <p>Asynchronous page updates will appear here:</p>
        <h3>Number list:</h3>
        <div id="log"> </div> <!-- /#log -->
    </div>
</div>
</h2>



</body>
</html>
